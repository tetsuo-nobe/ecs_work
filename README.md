# Amazon Elastic Container Service (ECS) と AWS Fargate のワーク

* このワークは、指定された AWS アカウントと IAM ユーザー/パスワードを使用して実施して下さい。
* ワークの環境は、許可されている期限内でのみ利用可能ですのでご了承ください。
---

## ワークの目的

* Amazon ECS クラスターで AWS Fargate を使用し、コンテナアプリケーションを実行するまでの手順をハンズオンで体験します。
    - コンテナイメージの構築から始めます。
    - コンテナイメージは、Amazon Elastic Container Registry (ECR) のリポジトリに格納します。

---

## 全体概要

* 下図のような環境を構築します。

図

### 手順

#### 0. 事前準備

* このワークを実施するために必要な 下記の AWS リソースを AWS CloudFormation で作成します。

#### 1. コンテナイメージの構築

1. VS Code Server の環境にアクセスします。


1. ターミナル で下記のコマンドを実行し、Docker がインストールされていることを確認します。   
   ```
   docker -v
   ```

1. サンプルの Git リポジトリを取得します。

   ```
   git clone https://github.com/tetsuo-nobe/ecs_work.git
   ```

1. サンプルのフォルダに移動します。

   ```
   cd ecs_work/myflask1
   ```
   
1. 左側に表示されている階層構造から myflask1/app フォルダの app.py を開いて、サンプルの アプリケーションのコードを確認します。(Python で Flask という Webアプリケーションフレームワークを使用しています。）


1. myflask1 フォルダの Dockerfile を確認します。
   - この Dockerfile を使用してコンテナのイメージをビルドします。


1. 下記のコマンドでコンテナイメージをビルドします。
   ```
   docker build -t myflask:1 . 
   ```   

1. 下記のコマンドでコンテナを実行します。
   ```
   docker run --name myflask1 -dit -p 80:8080 myflask:1
   ```   

1. サンプルアプリケーションのコンテナが動作していることを確認します。CONTAINER ID や NAMES が表示されていることを確認します。
   ```
   docker ps
   ```
   
1. サンプルアプリケーションのコンテナにアクセスします。
   ```
   curl localhost
   ```
   - `<h1>Hello, Flask!</h1>` と表示されることを確認します。

1. サンプルアプリケーションのコンテナを停止します。
   ```
   docker stop myflask1
   ```

#### 2. Amazon ECR のリポジトリを作成しコンテナイメージをプッシュする

1. 使用している AWS アカウント ID とリージョンを環境変数に設定します。
    - 下記は例です。ご自身の環境に応じた値に変更して下さい。
   
   ```
   ACCOUNT=123412341234
   ```

   ```
   REGION=ap-northeast-1
   ```

1. ターミナルで下記のコマンドを実行し、Amazon ECR のリポジトリ myflask1 を作成します。

   ```
   aws ecr create-repository --repository-name myflask --region ${REGION}
   ```
   - **実行後、プロンプトが戻らない場合はキーボードの q キーを押下して下さい。**

1. 認証トークンを取得し、レジストリに対して Docker クライアントを認証します。

   ````
   aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com
   ````

1. リポジトリにイメージをプッシュできるように、イメージにタグを付けます。

   ````
   docker tag myflask:1  ${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/myflask:latest
   ````

1. リポジトリにこのイメージをプッシュします。

   ````
   docker push ${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/myflask:latest
   ````

1. AWS マネジメントコンソールで Amazon ECR のページを表示し、リポジトリにイメージがプッシュされたことを確認します。


1. 次の手順に備えて、下記のコマンドで表示されるイメージ URI をメモしておきます。

    ````
    echo ${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/myflask:latest
    ````

#### 3. Amazon ECS タスク定義の作成

1. AWS マネジメントコンソールで Amazon ECS のページを表示します。


1. 左側のナビゲーションメニューから **タスク定義** をクリックします。

1. **新しいタスク定義の作成** をクリックして、さらに **新しいタスク定義の作成** をクリックします。

1. **タスク定義ファミリー** に `myflask` と入力します。

1. **インフラストラクチャの要件** で **起動タイプ** に **Fargate** を選択します。

1. ページを少し下にスクロールし、**コンテナ - 1** で下記を入力します。
    - **名前** に `myflask` と入力
    - **イメージ URI** にメモしておいた イメージ URI を入力
    - **ポートマッピング** で **コンテナポート** に `8080` を入力
    - 上記以外はデフォルトのままにします。
    - 入力後、ページを下までスクロールして、**作成** をクリックします。

#### 4. Amazon ECS クラスターの作成

1. 左側のナビゲーションメニューから **クラスター** をクリックします。

1. ページ右上あたりにある **クラスターの作成** をクリックします。

1. **クラスター設定** で **クラスター名** に `my-cluster` を入力します。

1. **インフラストラクチャ** で **AWS Fargate (サーバーレス)** だけがチェックされている状態にします。

1. ページを下までスクロールして、**作成** をクリックします。

#### 5. Amazon ECS クラスターでサービスの作成

1. 左側のナビゲーションメニューから **クラスター** をクリックします。

1. 表示されるクラスター一覧から **my-cluster** のリンク をクリックします。

1. ページ中央あたりにある **サービス** のタブをクリックします。

1. ページ中央あたりにある **サービス** のタブをクリックして、**作成** をクリックします。

1. ページを少し下にスクロールし、**デプロイ設定** セクションを表示します。

1. **ファミリー** で **myflask** を選択します。

1. **サービス名** に `my-service` と入力します。

1. **必要なタスク** に `2` と入力します。

1. ページを少し下にスクロールし、**ネットワーク** セクションを展開表示します。

1. **VPC** で、`my-VPC` を選択します。

1. **サブネット** で、**PublicSubnet01** と **PublicSubnet02** の **X** をクリックして削除します。
    - 結果、**PrivateSubnet01** と **PrivateSubnet02** だけが選択された状態にします。
   
1. **セキュリティグループ** で **既存のセキュリティグループを使用** を選択します。

1. **セキュリティグループ名** で **AppSG** を選択します。
    - **default のセキュリティグループは、X をクリックして削除して下さい。**

1. **パブリック IP** のトグルを OFF (無効化)します。

1. **ロードバランシング - オプション** セクションを展開表示します。

1. **ロードバランシングを使用** をチェックします。

1. **ロードバランサーの種類** で **Application Load Balancer** を選択します。

1. **Application Load Balancer** で **既存のロードバランサーを使用** を選択します。

1. **ロードバランサー** で **my-ALB** を選択します。

1. ページを下までスクロールして、**作成** をクリックします。

#### 6. タスクの実行確認






#### ワーク環境の作成